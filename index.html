<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel Marketing - Tijuca</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/recharts/umd/Recharts.min.js"></script>

  <style>
    :root {
      --tijuca-yellow: #f5a800;
      --tijuca-blue: #003a70;
      --tijuca-green: #00662f;
      --tijuca-red: #cc0000;
    }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDKNqGVrjbj8l7S7OIvN-w3CKmsj8twC98",
      authDomain: "crm-marketing-b7767.firebaseapp.com",
      projectId: "crm-marketing-b7767",
      storageBucket: "crm-marketing-b7767.appspot.com",
      messagingSenderId: "27887822785",
      appId: "1:27887822785:web:4e4bee6d07cc9007433140",
      measurementId: "G-LX1Z71R97G",
    };

    let db;

    async function initializeFirebase() {
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      const auth = getAuth(app);
      await signInAnonymously(auth);
      onAuthStateChanged(auth, (user) => {
        if (user) updateDashboard();
      });
    }

    async function updateDashboard() {
      const totals = {
        doacoes: (await getDocs(collection(db, "doacoes_v2"))).size,
        patrocinios: (await getDocs(collection(db, "patrocinios_v2"))).size,
        midia: (await getDocs(collection(db, "midia_v2"))).size,
        midia_ooh: (await getDocs(collection(db, "midia_ooh_v2"))).size,
      };

      document.getElementById("doacoes-count").innerText = totals.doacoes;
      document.getElementById("patrocinios-count").innerText = totals.patrocinios;
      document.getElementById("midia-count").innerText = totals.midia;
      document.getElementById("midia-ooh-count").innerText = totals.midia_ooh;

      await loadLatest("doacoes_v2", "doacoes-list", "projeto", "responsavel");
      await loadLatest("patrocinios_v2", "patrocinios-list", "entidade", "responsavel");
      await loadLatest("midia_v2", "midia-list", "campanha", "responsavel");
      await loadLatest("midia_ooh_v2", "midia-ooh-list", "local", "responsavel");

      renderCharts("12");
    }

    async function loadLatest(collectionName, containerId, detailField, responsavelField) {
      const q = query(collection(db, collectionName), orderBy("timestamp", "desc"), limit(3));
      const snapshot = await getDocs(q);

      const container = document.getElementById(containerId);
      container.innerHTML = "";

      if (snapshot.empty) {
        container.innerHTML = `<p class="text-gray-500">Sem registros ainda.</p>`;
        return;
      }

      snapshot.forEach(doc => {
        const data = doc.data();
        const responsavel = data[responsavelField] || "N/A";
        const detalhe = data[detailField] || "";
        const dataSolicitacao = data.dataSolicitacao || data.data || "";
        const status = data.status || "";

        let badge = "";
        if (status) {
          let colorClass =
            status === "Aprovado"
              ? "bg-[var(--tijuca-green)] text-white"
              : status === "Negado"
              ? "bg-[var(--tijuca-red)] text-white"
              : "bg-[var(--tijuca-yellow)] text-black";
          badge = `<span class="ml-2 px-2 py-1 text-xs font-semibold rounded ${colorClass}">${status}</span>`;
        }

        container.innerHTML += `
          <div class="flex items-center justify-between border-b py-2">
            <div>
              <p class="font-semibold text-[var(--tijuca-blue)]">${responsavel} <span class="text-sm text-gray-500">- ${dataSolicitacao}</span></p>
              <p class="text-sm text-gray-600">${detalhe}</p>
            </div>
            ${badge}
          </div>
        `;
      });
    }

    /* -------- GR√ÅFICOS COM FILTRO -------- */
    async function renderCharts(period = "12") {
      const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, BarChart, Bar } = window.Recharts;
      const months = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
      const collections = ["doacoes_v2", "patrocinios_v2", "midia_v2", "midia_ooh_v2"];

      const now = new Date();
      const currentYear = now.getFullYear();

      const monthly = {};
      for (let i = 0; i < 12; i++) monthly[i] = { doacoes: 0, patrocinios: 0, midia: 0, midia_ooh: 0 };
      const totals = { doacoes: 0, patrocinios: 0, midia: 0, midia_ooh: 0 };

      for (const col of collections) {
        const snapshot = await getDocs(collection(db, col));
        snapshot.forEach((doc) => {
          const data = doc.data();
          const ts = data.timestamp?.toDate?.() || new Date();
          const month = ts.getMonth();
          const year = ts.getFullYear();

          let include = false;
          if (period === "ano" && year === currentYear) include = true;
          if (period === "3") {
            const diff = (now.getMonth() - month + 12) % 12;
            include = year === currentYear && diff < 3;
          }
          if (period === "12") include = true;

          if (include) {
            if (col === "doacoes_v2") { monthly[month].doacoes++; totals.doacoes++; }
            if (col === "patrocinios_v2") { monthly[month].patrocinios++; totals.patrocinios++; }
            if (col === "midia_v2") { monthly[month].midia++; totals.midia++; }
            if (col === "midia_ooh_v2") { monthly[month].midia_ooh++; totals.midia_ooh++; }
          }
        });
      }

      const chartData = months.map((m, i) => ({
        name: m,
        doacoes: monthly[i].doacoes,
        patrocinios: monthly[i].patrocinios,
        midia: monthly[i].midia,
        midia_ooh: monthly[i].midia_ooh,
      }));

      // Gr√°fico de Barras
      const BarChartComp = () => React.createElement(
        ResponsiveContainer, { width: "100%", height: 250 },
        React.createElement(BarChart, { data: [
          { name: "Doa√ß√µes", total: totals.doacoes },
          { name: "Patroc√≠nios", total: totals.patrocinios },
          { name: "M√≠dias", total: totals.midia },
          { name: "M√≠dia OOH", total: totals.midia_ooh },
        ] },
          React.createElement(CartesianGrid, { strokeDasharray: "3 3" }),
          React.createElement(XAxis, { dataKey: "name" }),
          React.createElement(YAxis, null),
          React.createElement(Tooltip, null),
          React.createElement(Bar, { dataKey: "total", fill: "var(--tijuca-green)" })
        )
      );

      // Gr√°fico de Linhas
      const LineChartComp = () => React.createElement(
        ResponsiveContainer, { width: "100%", height: 280 },
        React.createElement(LineChart, { data: chartData },
          React.createElement(CartesianGrid, { strokeDasharray: "3 3" }),
          React.createElement(XAxis, { dataKey: "name" }),
          React.createElement(YAxis, null),
          React.createElement(Tooltip, null),
          React.createElement(Legend, null),
          React.createElement(Line, { type: "monotone", dataKey: "doacoes", stroke: "var(--tijuca-green)", strokeWidth: 2 }),
          React.createElement(Line, { type: "monotone", dataKey: "patrocinios", stroke: "var(--tijuca-yellow)", strokeWidth: 2 }),
          React.createElement(Line, { type: "monotone", dataKey: "midia", stroke: "var(--tijuca-blue)", strokeWidth: 2 }),
          React.createElement(Line, { type: "monotone", dataKey: "midia_ooh", stroke: "var(--tijuca-red)", strokeWidth: 2 })
        )
      );

      ReactDOM.render(React.createElement(BarChartComp), document.getElementById("chart-container"));
      ReactDOM.render(React.createElement(LineChartComp), document.getElementById("chart-monthly"));
    }

    document.addEventListener("change", (e) => {
      if (e.target.id === "chart-filter") {
        renderCharts(e.target.value);
      }
    });

    window.onload = initializeFirebase;
  </script>
</head>

<body class="bg-gray-100 p-6">
  <!-- Navbar -->
  <nav class="bg-gray-100 shadow-md fixed top-0 left-0 w-full z-50">
    <div class="max-w-7xl mx-auto px-4">
      <div class="flex justify-between items-center h-14">
        
        <!-- Logo + Nome -->
        <div class="flex items-center space-x-2">
          <img src="https://i.postimg.cc/bvySmsHG/Prancheta-1-4x.png" alt="Tijuca Logo" class="h-8">
          <span class="font-bold text-[var(--tijuca-blue)] text-lg">Tijuca Marketing</span>
        </div>

        <!-- Links -->
        <div class="hidden md:flex space-x-6">
          <a href="doacoes.html" class="text-[var(--tijuca-green)] font-medium hover:underline">Doa√ß√µes</a>
          <a href="patrocinios.html" class="text-[var(--tijuca-green)] font-medium hover:underline">Patroc√≠nios</a>
          <a href="midia.html" class="text-[var(--tijuca-green)] font-medium hover:underline">M√≠dias</a>
          <a href="midia_ooh.html" class="text-[var(--tijuca-green)] font-medium hover:underline">M√≠dia OOH</a>
        </div>

        <!-- Bot√£o Dark Mode -->
        <button id="dark-toggle" class="bg-[var(--tijuca-green)] text-white px-3 py-1 rounded flex items-center gap-1 text-sm">
          üåû / üåô
        </button>
      </div>
    </div>
  </nav>
  <div class="h-16"></div> <!-- compensar navbar fixa -->

  <!-- Estat√≠sticas r√°pidas -->
  <section class="grid md:grid-cols-4 gap-4 mb-8">
    <div class="bg-white rounded-xl shadow p-4 text-center border-b-4" style="border-color: var(--tijuca-green);">
      <h2 class="text-lg font-semibold text-[var(--tijuca-green)]">Doa√ß√µes</h2>
      <p id="doacoes-count" class="text-3xl font-bold mt-2 text-[var(--tijuca-blue)]">0</p>
    </div>
    <div class="bg-white rounded-xl shadow p-4 text-center border-b-4" style="border-color: var(--tijuca-yellow);">
      <h2 class="text-lg font-semibold text-[var(--tijuca-yellow)]">Patroc√≠nios</h2>
      <p id="patrocinios-count" class="text-3xl font-bold mt-2 text-[var(--tijuca-blue)]">0</p>
    </div>
    <div class="bg-white rounded-xl shadow p-4 text-center border-b-4" style="border-color: var(--tijuca-blue);">
      <h2 class="text-lg font-semibold text-[var(--tijuca-blue)]">M√≠dias</h2>
      <p id="midia-count" class="text-3xl font-bold mt-2 text-[var(--tijuca-blue)]">0</p>
    </div>
    <div class="bg-white rounded-xl shadow p-4 text-center border-b-4" style="border-color: var(--tijuca-red);">
      <h2 class="text-lg font-semibold text-[var(--tijuca-red)]">M√≠dia OOH</h2>
      <p id="midia-ooh-count" class="text-3xl font-bold mt-2 text-[var(--tijuca-blue)]">0</p>
    </div>
  </section>

  <!-- Se√ß√µes -->
  <section class="grid md:grid-cols-2 gap-6 mb-8">
    <div class="bg-white p-6 rounded-xl shadow">
      <h2 class="flex items-center text-xl font-bold text-[var(--tijuca-green)] mb-4">
        <img src="https://i.postimg.cc/d19whLDh/Ativo-1.png" class="h-6 w-6 mr-2"> DOA√á√ïES <span class="ml-auto text-gray-500" id="doacoes-count">0</span>
      </h2>
      <div id="doacoes-list"></div>
      <a href="doacoes.html" class="text-blue-600 hover:underline block mt-2">Ver todas ‚Üí</a>
    </div>

    <div class="bg-white p-6 rounded-xl shadow">
      <h2 class="flex items-center text-xl font-bold text-[var(--tijuca-yellow)] mb-4">
        <img src="https://i.postimg.cc/bN4rcStQ/Patrocinio.png" class="h-6 w-6 mr-2"> PATROC√çNIOS <span class="ml-auto text-gray-500" id="patrocinios-count">0</span>
      </h2>
      <div id="patrocinios-list"></div>
      <a href="patrocinios.html" class="text-blue-600 hover:underline block mt-2">Ver todas ‚Üí</a>
    </div>

    <div class="bg-white p-6 rounded-xl shadow">
      <h2 class="flex items-center text-xl font-bold text-[var(--tijuca-blue)] mb-4">
        <img src="https://i.postimg.cc/FsYzBV7D/Midias.png" class="h-6 w-6 mr-2"> M√çDIAS <span class="ml-auto text-gray-500" id="midia-count">0</span>
      </h2>
      <div id="midia-list"></div>
      <a href="midia.html" class="text-blue-600 hover:underline block mt-2">Ver todas ‚Üí</a>
    </div>

    <div class="bg-white p-6 rounded-xl shadow">
      <h2 class="flex items-center text-xl font-bold text-[var(--tijuca-red)] mb-4">
        <img src="https://i.postimg.cc/Gh4t5xHF/Midia-OOH-1.png" class="h-6 w-6 mr-2"> M√çDIA OOH <span class="ml-auto text-gray-500" id="midia-ooh-count">0</span>
      </h2>
      <div id="midia-ooh-list"></div>
      <a href="midia_ooh.html" class="text-blue-600 hover:underline block mt-2">Ver todas ‚Üí</a>
    </div>
  </section>

  <!-- Gr√°ficos -->
  <section class="bg-white rounded-2xl shadow-lg p-6 mb-8">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold text-[var(--tijuca-green)]">Resumo de Registros por Tipo</h2>
      <select id="chart-filter" class="border rounded p-2 text-sm">
        <option value="3">√öltimos 3 meses</option>
        <option value="ano">Ano atual</option>
        <option value="12" selected>√öltimos 12 meses</option>
      </select>
    </div>
    <div id="chart-container" style="width:100%; height:250px;"></div>
  </section>

  <section class="bg-white rounded-2xl shadow-lg p-6 mb-10">
    <h2 class="text-xl font-bold mb-4 text-[var(--tijuca-green)]">Evolu√ß√£o Mensal de Registros</h2>
    <div id="chart-monthly" style="width:100%; height:280px;"></div>
  </section>

  <!-- Dark Mode -->
  <script>
    const toggleBtn = document.getElementById("dark-toggle");
    toggleBtn.addEventListener("click", () => {
      document.documentElement.classList.toggle("dark");
      if (document.documentElement.classList.contains("dark")) {
        document.body.classList.add("bg-gray-900", "text-white");
        toggleBtn.innerHTML = "üåô";
      } else {
        document.body.classList.remove("bg-gray-900", "text-white");
        toggleBtn.innerHTML = "üåû / üåô";
      }
    });
  </script>
</body>
</html>
